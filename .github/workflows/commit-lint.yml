name: Commit Linter

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  # ============================================
  # V√©rifier les messages de commit
  # ============================================
  lint-commits:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          echo "üîç Validation des messages de commit..."
          
          # Liste des commits dans le PR
          COMMITS=$(git log origin/${{ github.base_ref }}..HEAD --pretty=format:"%s")
          
          # Pattern pour Conventional Commits
          PATTERN="^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?(!)?: .{1,100}"
          
          INVALID_COMMITS=""
          ERROR_COUNT=0
          
          while IFS= read -r commit; do
            if ! echo "$commit" | grep -qE "$PATTERN"; then
              INVALID_COMMITS="$INVALID_COMMITS\n- $commit"
              ERROR_COUNT=$((ERROR_COUNT + 1))
            fi
          done <<< "$COMMITS"
          
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "‚ùå $ERROR_COUNT commit(s) invalide(s) d√©tect√©(s):"
            echo -e "$INVALID_COMMITS"
            echo ""
            echo "‚ÑπÔ∏è  Les commits doivent suivre le format Conventional Commits:"
            echo "   <type>(<scope>): <description>"
            echo ""
            echo "Types autoris√©s:"
            echo "  - feat:     Nouvelle fonctionnalit√©"
            echo "  - fix:      Correction de bug"
            echo "  - docs:     Documentation"
            echo "  - style:    Formatage, lint"
            echo "  - refactor: Refactoring"
            echo "  - perf:     Performance"
            echo "  - test:     Tests"
            echo "  - build:    Build syst√®me"
            echo "  - ci:       CI/CD"
            echo "  - chore:    Maintenance"
            echo "  - revert:   Revert d'un commit"
            echo ""
            echo "Exemples:"
            echo "  ‚úÖ feat(auth): add JWT authentication"
            echo "  ‚úÖ fix(api): resolve CORS issue"
            echo "  ‚úÖ docs: update README with Docker instructions"
            echo "  ‚ùå Added new feature"
            echo "  ‚ùå fix bug"
            exit 1
          else
            echo "‚úÖ Tous les commits sont valides!"
          fi

      - name: Add PR comment on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ‚ö†Ô∏è Messages de commit invalides

            Les commits de cette PR ne suivent pas les [Conventional Commits](https://www.conventionalcommits.org/).

            ### Format attendu
            \`\`\`
            <type>(<scope>): <description>

            [optional body]

            [optional footer]
            \`\`\`

            ### Types autoris√©s
            - \`feat:\` - Nouvelle fonctionnalit√©
            - \`fix:\` - Correction de bug
            - \`docs:\` - Documentation
            - \`style:\` - Formatage, lint
            - \`refactor:\` - Refactoring
            - \`perf:\` - Performance
            - \`test:\` - Tests
            - \`build:\` - Build syst√®me
            - \`ci:\` - CI/CD
            - \`chore:\` - Maintenance

            ### Exemples
            \`\`\`
            ‚úÖ feat(auth): add JWT authentication
            ‚úÖ fix(api): resolve CORS issue with frontend
            ‚úÖ docs: update README with Docker instructions
            ‚úÖ feat!: breaking change in API response format
            ‚ùå Added new feature
            ‚ùå fix bug
            ‚ùå Update
            \`\`\`

            ### Breaking Changes
            Pour signaler un breaking change, ajoutez \`!\` apr√®s le type :
            \`\`\`
            feat!: redesign user authentication system
            \`\`\`

            Ou dans le footer :
            \`\`\`
            feat(api): change response format

            BREAKING CHANGE: API now returns data in a different structure
            \`\`\`

            Veuillez reformuler vos commits avant de merger cette PR. üôè
            `
            })

      - name: Add success comment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ Tous les messages de commit suivent les Conventional Commits! üéâ'
            })
